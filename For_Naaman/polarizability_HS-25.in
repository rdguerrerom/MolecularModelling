memory 8gb
molecule {
    symmetry c1 # this is important; some perturbations will break symmetry
#    no_reorient
N         0.22865335412548   -2.41847723888949   -0.01094411566058
C         0.28297197222917   -2.35524545361232    1.31808412563266
C         0.20317278977531   -1.28482706750435   -0.68294675580940
C         0.09256630109172   -0.07777106661480   -2.60220049375416
C         0.36342044649744    2.18184540506590    1.32341358362285
N         0.24619262948058   -0.08440569754532    0.01297537281376
N         0.13372175859043   -1.26378347577838   -1.99922923353959
N         0.26868226127516    2.25040949236675   -0.00246008077993
N         0.32832303407930   -1.23799402906009    2.04037351299192
C         0.29226911220659   -3.61794359632660    2.04754248278931
N         0.38381884326671    1.06138537609837    2.04241330799309
C         0.32070471324918   -0.08700854521599    1.39891653364884
C         0.45302575221793    3.44232514890684    2.05100848883318
C         0.21200809423249    1.11952199706044   -0.67659655387840
N         0.12688355589371    1.10486818621062   -1.99126407150776
C         0.00240977166180   -0.06618173146014   -4.05763257327488
H         0.32683115098431   -4.80292753579700    0.27353972767484
C         0.29425779905552   -3.62119414164239    3.44370775182549
C         0.29341082227975   -6.02982566916202    3.43450394694620
C         0.31007624933837   -4.82748742549672    1.35160527531806
C         0.31143629003497   -7.27927924466031    4.24850328007023
H         0.36252282383415   -6.94753362946315    1.48070356026860
C         0.31180874284905   -6.02335098690324    2.03958716056086
C         0.29955786409428   -4.81822032088844    4.12604258028863
H         0.29383229959245   -2.67700323008642    3.96431239384239
H         0.30921842321662   -4.84515615626362    5.20527433739518
C         0.01239693293139   -1.26173233505347   -4.77811196346894
C        -0.07248188250232   -1.23308343427019   -6.15360203604132
H        -0.31428334439861    2.12404243134973   -6.60956493292248
C        -0.10852377820504    1.14970689583217   -4.73397044589514
H         0.08487246670732   -2.19229122558799   -4.23824429291336
H        -0.13285074799435    2.06068284333980   -4.15735141990869
C        -0.19067024340695    1.17296943712603   -6.11040625952817
C        -0.15942277317943   -0.01886799517196   -6.83495096635354
C        -0.26278326506273   -0.06985967505325   -8.32217201016887
H        -0.07426766654952   -2.14518664645380   -6.73123381910501
C         0.72577225767647    7.16588602026308    4.12701823336592
H         0.44348749415886    6.79299202696661    1.55114851659600
C         0.48093593789612    5.84222705612847    2.06123908234087
H         0.87459187264478    4.59794992833940    5.19701997967728
H         0.27457593826268    4.64102318922750    0.29303755290933
C         0.62464460686582    5.84141481649887    3.44881027710120
C         0.62091946907962    3.43657348974079    3.43644520027289
C         0.70719280244579    4.62630259126728    4.12921788433012
H         0.68616209624752    2.48770323599197    3.94483188857891
C         0.39056677397325    4.65653490523201    1.36488436728830
O         0.79447023439818   -7.33924651622485    5.35779860832909
N        -0.28600186410313   -8.35518100758828    3.63727369317838
C        -0.45821341886540  -11.87777956682277    5.40139499735597
N         0.24441708729709    1.04033544469155   -8.95302764330552
O        -0.73966404824117   -1.00794267448294   -8.92201130829647
C        -1.17681834002317   10.47307116359428   12.59153080660678
C         0.22531015331500    1.20513483501842  -10.28130997070021
H         0.71877446462194   11.31270733996550    7.19687521820103
C         0.17130967379364    1.31767948942752  -11.48201647037357
C         0.34276021145701   10.40935087198630    7.66314273805589
C        -2.54622671596318  -16.08721864836684    3.27496377372034
C        -0.36942774982912   -9.56256625435506    4.20957354393413
C         0.12294895657113    1.48554802610721  -12.86969142093103
C        -2.02445482148993  -15.02157302385581    3.80812932740052
C         0.51793407026916    2.58659288200812  -13.47958576845858
C        -0.42721764284767   10.43587839597910   10.12860453102051
C        -0.40318812301220  -10.62777674064884    4.77667645780910
H        -0.26504456776569    0.65089167105763  -13.44212154715441
C         0.88804451963837    3.64250017432511  -14.06745752464952
H        -0.48770918988781   10.26473389446759   13.39543007045326
C         1.25187558710836    4.70747396625128  -14.66443672717986
H         0.93482714112430    6.60496804663010  -15.45687901747520
C        -1.51206309898113  -13.97729403428435    4.32758929507237
H        -3.58734425283364  -16.33680519084664    3.40959509048170
C         1.62443329400597    5.79571295768701  -15.27195104300774
C        -0.99885442757571  -12.94624095096700    4.84823560527097
H        -1.95886772840866  -16.76700321626405    2.67728267772666
O         1.16412876373209    8.15638026258534    3.58478439881313
N         0.26048983873790    7.16697880469390    5.41979614018338
H        -0.02058883455742  -11.93699958389894    6.39155322688491
C         0.26941229348640    8.25470483512531    6.20003578743367
C        -0.05277983106460   10.42248657359048    8.92151135569109
C         0.31196004136403    9.26396266992886    6.86115825514186
H        -2.19484990449436   10.69550967123509   12.87189014230603
C        -0.79859586401190   10.45646818199056   11.34702087075818
H         2.63741666620708    5.93446868452176  -15.61709872258882
H        -0.15905049982251    6.33103497667136    5.80346346567967
H         0.69728927568591    1.76257886060919   -8.40960114613905
H        -0.73685315178029   -8.23885219058750    2.73999985228453

}

pert = 0.001
lambdas = [pert, -pert, 2.0*pert, -2.0*pert]

set {
    basis     6-31g
    d_convergence   8
    reference rhf
    scf_type direct
}
method = 'B3LYP'

perturbed_energies = np.zeros((len(lambdas),3))
x_perturbed_dipoles = np.zeros((len(lambdas),3))
y_perturbed_dipoles = np.zeros((len(lambdas),3))
z_perturbed_dipoles = np.zeros((len(lambdas),3))

# start with a reference dipole calculation
properties(method, properties=['dipole'])
mu_x = psi4.core.variable(method + ' DIPOLE X') / psi_dipmom_au2debye
mu_y = psi4.core.variable(method + ' DIPOLE Y') / psi_dipmom_au2debye
mu_z = psi4.core.variable(method + ' DIPOLE Z') / psi_dipmom_au2debye
analytic_dipole = np.array([mu_x, mu_y, mu_z])

# now compute with different applied fields
for step, l in enumerate(lambdas):
    set perturb_h true
    set perturb_with dipole
    # x pertubation
    set perturb_dipole [$l, 0, 0]
    perturbed_energies[step,0] = properties(method, properties=['dipole'])
    x_perturbed_dipoles[step,0] = psi4.core.variable(method + ' DIPOLE X')
    x_perturbed_dipoles[step,1] = psi4.core.variable(method + ' DIPOLE Y')
    x_perturbed_dipoles[step,2] = psi4.core.variable(method + ' DIPOLE Z')
    # y pertubation
    set perturb_dipole [0, $l, 0]
    perturbed_energies[step,1] = properties(method, properties=['dipole'])
    y_perturbed_dipoles[step,0] = psi4.core.variable(method + ' DIPOLE X')
    y_perturbed_dipoles[step,1] = psi4.core.variable(method + ' DIPOLE Y')
    y_perturbed_dipoles[step,2] = psi4.core.variable(method + ' DIPOLE Z')
    # z pertubation
    set perturb_dipole [0, 0, $l]
    perturbed_energies[step,2] = properties(method, properties=['dipole'])
    z_perturbed_dipoles[step,0] = psi4.core.variable(method + ' DIPOLE X')
    z_perturbed_dipoles[step,1] = psi4.core.variable(method + ' DIPOLE Y')
    z_perturbed_dipoles[step,2] = psi4.core.variable(method + ' DIPOLE Z')

# use 3- and 5-point finite difference formulae to compute the dipole
mu_3pt = (perturbed_energies[0] - perturbed_energies[1]) / (2.0*pert)
mu_5pt = (8.0*perturbed_energies[0] - 8.0*perturbed_energies[1] - perturbed_energies[2] + perturbed_energies[3]) / (12.0*pert)
# and the polarizability
a_x_3pt = (x_perturbed_dipoles[0] - x_perturbed_dipoles[1]) / (2.0*pert)
a_y_3pt = (y_perturbed_dipoles[0] - y_perturbed_dipoles[1]) / (2.0*pert)
a_z_3pt = (z_perturbed_dipoles[0] - z_perturbed_dipoles[1]) / (2.0*pert)
alpha_3pt = np.vstack((a_x_3pt, a_y_3pt, a_z_3pt))
a_x_5pt = (8.0*x_perturbed_dipoles[0] - 8.0*x_perturbed_dipoles[1] - x_perturbed_dipoles[2] + x_perturbed_dipoles[3]) / (12.0*pert)
a_y_5pt = (8.0*y_perturbed_dipoles[0] - 8.0*y_perturbed_dipoles[1] - y_perturbed_dipoles[2] + y_perturbed_dipoles[3]) / (12.0*pert)
a_z_5pt = (8.0*z_perturbed_dipoles[0] - 8.0*z_perturbed_dipoles[1] - z_perturbed_dipoles[2] + z_perturbed_dipoles[3]) / (12.0*pert)
alpha_5pt = np.vstack((a_x_5pt, a_y_5pt, a_z_5pt))

# let's see what happened!
np.set_printoptions(suppress=True)
print('Analytic dipole\n', analytic_dipole)
print('3point finite difference dipole\n', mu_3pt)
print('5point finite difference dipole\n', mu_5pt)

print('3point finite difference polarizability\n', alpha_3pt)
print('5point finite difference polarizability\n', alpha_5pt)
